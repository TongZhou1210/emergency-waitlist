<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Priority</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body class="admin-body">
<header class="app-header">
    <h1 class="app-title">Update Priority</h1>
</header>

<main class="main">
    <div class="card">

        <!-- Search patient by ID -->
        <div class="form-group">
            <label for="searchId">Search patient by ID</label>

            <!-- Search box + icon on the RIGHT -->
            <div class="search-group">
                <input id="searchId"
                       type="search"
                       placeholder="Enter patient ID">

                <!-- Clickable search icon button -->
                <button type="button"
                        class="search-button"
                        onclick="handleSearch()"
                        aria-label="Search">
                    &#128269;
                </button>
            </div>

            <!-- Search result message -->
            <p id="searchMessage" class="form-hint"></p>
        </div>

        <!-- Grey area: empty before search, shows info only after a valid search -->
        <div id="statusContainer" class="status-block empty">
            <div class="status-row">
                <strong>Patient Name:</strong>
                <span id="statusPatientName">John Doe</span>
            </div>
            <div class="status-row">
                <strong>Current Triage Level:</strong>
                <span id="statusCurrentLevel">Level 2</span>
            </div>
        </div>

        <h3>Choose new level</h3>

        <!-- Level selection buttons -->
        <div class="button-row">
            <button type="button"
                    class="btn level-choice level-1"
                    onclick="selectLevel(1)">
                Level 1
            </button>

            <button type="button"
                    class="btn level-choice level-2"
                    onclick="selectLevel(2)">
                Level 2
            </button>

            <button type="button"
                    class="btn level-choice level-3"
                    onclick="selectLevel(3)">
                Level 3
            </button>
        </div>

        <div class="form-group">
            <label for="reason">Reason</label>
            <textarea id="reason"
                      placeholder="Explain why the triage level is changed"></textarea>
        </div>

        <div class="form-group">
            <label for="changedBy">Changed by</label>
            <input id="changedBy" type="text" placeholder="Staff name">
        </div>

        <div class="button-row">
            <a href="admin_home.html" class="btn btn-secondary">Cancel</a>

            <!-- Save now uses JS validation -->
            <button type="button"
                    class="btn btn-primary"
                    onclick="handleSave()">
                Save
            </button>
        </div>

        <div class="section" style="margin-top:16px;">
            <a href="#"
               id="fullInfoLink"
               title="Please enter a patient ID first."
               onclick="handleViewInfo(event)">
                View full patient info
            </a>
        </div>

    </div>
</main>

<script>
    /* ---------------------------------------------
       Temporary mock database (for front-end demo)
       --------------------------------------------- */
    const PATIENT_DB = {
        "00123": {
            name: "John Doe",
            triage: "Level 2"
        }
        // add more ids here if needed
    };

    // Stores the last successfully found patient ID
    let selectedPatientId = null;

    /* Helper: get query parameter from URL */
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    /* On page load: if URL has ?id=..., auto search that patient */
    document.addEventListener('DOMContentLoaded', () => {
        const initialId = getQueryParam('id');
        if (initialId) {
            const input = document.getElementById('searchId');
            input.value = initialId;
            handleSearch(); // will fill the grey block if id exists
        }
    });

    /* ---------------------------------------------
       Search function triggered by the search icon
       --------------------------------------------- */
    function handleSearch() {
        const idInput = document.getElementById('searchId');
        const messageEl = document.getElementById('searchMessage');
        const statusBox = document.getElementById('statusContainer');
        const nameSpan = document.getElementById('statusPatientName');
        const triageSpan = document.getElementById('statusCurrentLevel');
        const infoLink = document.getElementById('fullInfoLink');

        const id = idInput.value.trim();

        // Reset selected patient before each search
        selectedPatientId = null;

        // Default link state: disabled
        infoLink.href = "#";
        infoLink.title = "Please enter a valid patient ID first.";

        // Empty input check
        if (!id) {
            statusBox.classList.add('empty');   // show blank grey area
            messageEl.textContent = "Please enter a patient ID.";
            return;
        }

        // Lookup patient from the mock database
        const patient = PATIENT_DB[id];

        if (patient) {
            // If found: show info inside grey box
            messageEl.textContent = "";
            nameSpan.textContent = patient.name;
            triageSpan.textContent = patient.triage;

            statusBox.classList.remove('empty');
            selectedPatientId = id;

            // Update link so it points to the correct patient
            infoLink.href = "admin_patient_info.html?id=" + encodeURIComponent(id);
            infoLink.title = "View full info for patient " + id + ".";
        } else {
            // If not found: keep grey block but hide text
            statusBox.classList.add('empty');
            messageEl.textContent = "No patient found. Please try another ID.";
        }
    }

    /* ---------------------------------------------
       Level selection function
       --------------------------------------------- */
    function selectLevel(level) {
        const buttons = document.querySelectorAll('.level-choice');

        // Remove active class from all buttons
        buttons.forEach(btn => {
            btn.classList.remove('active');
        });

        // Add active class to the selected button
        const selected = document.querySelector(".level-choice.level-" + level);
        if (selected) {
            selected.classList.add('active');
        }
    }

    /* ---------------------------------------------
       Guard for "View full patient info" link
       --------------------------------------------- */
    function handleViewInfo(event) {
        if (!selectedPatientId) {
            event.preventDefault();
            alert("Please search for a valid patient ID first.");
        }
    }

    /* ---------------------------------------------
       Save button validation
       --------------------------------------------- */
    function handleSave() {
        // 1) Must have a valid patient selected
        if (!selectedPatientId) {
            alert("Please search for a valid patient ID before saving.");
            return;
        }

        // 2) Must have chosen a level
        const activeLevel = document.querySelector(".level-choice.active");
        if (!activeLevel) {
            alert("Please choose a new triage level before saving.");
            return;
        }

        // For now, just simulate saving and go back to admin home
        alert("Changes saved for patient " + selectedPatientId + ".");
        window.location.href = "admin_home.html";
    }
</script>

</body>
</html>